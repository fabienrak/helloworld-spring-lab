name: Backend Deploy (DEV)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout le code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Setup Java 21
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # 3ï¸âƒ£ Build Spring Boot backend
      - name: Build backend JAR
        run: mvn clean package -DskipTests

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
        run: |
          echo "âœ… DÃ©codage de la clÃ© SSH..."
          echo "$VPS_SSH_KEY" | base64 -d > deploy_key.pem
          chmod 600 deploy_key.pem

          echo "âœ… Copie du JAR vers le serveur..."
          scp -i deploy_key.pem -o StrictHostKeyChecking=no -P $VPS_SSH_PORT ./target/helloworld-0.0.1-SNAPSHOT.jar $VPS_USER@$VPS_HOST:/var/www/srv/api/helloWorld/target/

          echo "âœ… RedÃ©marrage Docker sur le serveur..."
          ssh -i deploy_key.pem -o StrictHostKeyChecking=no -p $VPS_SSH_PORT $VPS_USER@$VPS_HOST << 'EOF'
            cd /var/www/srv/api/helloWorld
            docker compose down
            docker compose up -d --build
          EOF

          rm -f deploy_key.pem
          echo "ðŸŽ‰ DÃ©ploiement terminÃ© !"


      # 4ï¸âƒ£ Deploy to VPS
      # - name: Deploy to VPS
      #   uses: appleboy/ssh-action@v0.1.9
      #   with:
      #     host: ${{ secrets.VPS_HOST }}
      #     username: ${{ secrets.VPS_USER }}
      #     key: ${{ secrets.VPS_SSH_KEY }}
      #     port: ${{ secrets.VPS_SSH_PORT }}
      #     script: |
      #       echo "âœ… Pull latest code and copy JAR..."
      #       cd /var/www/srv/api/helloWorld

      #       # Supprimer l'ancien JAR
      #       rm -f target/*.jar

      #       # Copier le JAR depuis GitHub Actions
      #       scp -i ${{ secrets.VPS_SSH_KEY }} ./target/helloworld-0.0.1-SNAPSHOT.jar root@${{ secrets.VPS_HOST }}:/var/www/srv/api/helloWorld/target/

      #       echo "âœ… Rebuild et relance des containers Docker..."
      #       docker compose down
      #       docker compose up -d --build

      #       echo "ðŸŽ‰ DÃ©ploiement backend terminÃ© !"
